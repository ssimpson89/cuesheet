<!DOCTYPE html>
<html>
<head>
    <title>Director - CueSheet System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <script src="/static/vendor/tailwindcss.js"></script>
    <script defer src="/static/vendor/lucide.js"></script>
    <style>
        .camera-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        @media (min-width: 1024px) {
            .camera-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        @media (min-width: 1536px) {
            .camera-grid {
                grid-template-columns: repeat(6, 1fr);
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans h-screen flex flex-col m-0 p-0">
    <!-- Header with Aladdin Jr title and home button -->
    <header class="bg-slate-800 border-b border-slate-700 py-3 px-4 flex items-center justify-between">
        <a href="/" class="text-xl font-bold text-white hover:text-blue-400 transition-colors flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
            </svg>
            <span id="serviceName">Loading...</span>
        </a>
        <div>
            <h1 class="text-xl font-semibold">Director View</h1>
            <div id="scriptName" class="text-base text-gray-400">Loading...</div>
        </div>
    </header>
    
    <main class="flex-1 overflow-y-auto p-6 max-w-[1800px] mx-auto w-full">
        <!-- Status -->
        <div id="status" class="text-center py-2 bg-red-900/20 border border-red-700/50 text-red-400 rounded-lg text-sm mb-6">Connecting...</div>
        
        <!-- Current Cue Section -->
        <div id="currentCue" class="mb-8">
            <p class="text-center text-gray-500 py-10">Loading...</p>
        </div>
        
        <!-- Upcoming Cues Section -->
        <div id="upcomingSection" class="mt-8"></div>
    </main>
    
    <script>
        let ws;
        let currentState = null;
        
        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
            
            ws.onopen = () => {
                document.getElementById('status').textContent = '‚óè Connected - Live Updates Active';
                document.getElementById('status').className = 'text-center py-2 bg-emerald-900/20 border border-emerald-700/50 text-emerald-400 rounded-lg text-sm mb-6';
                // Data is already loaded by the immediate calls
            };
            
            ws.onclose = () => {
                document.getElementById('status').textContent = '‚óè Disconnected - Reconnecting...';
                document.getElementById('status').className = 'text-center py-2 bg-red-900/20 border border-red-700/50 text-red-400 rounded-lg text-sm mb-6';
                setTimeout(connect, 2000);
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'state_update') {
                    currentState = data.state;
                    if (data.state && data.state.script_name) {
                        document.getElementById('serviceName').textContent = data.state.script_name;
                    }
                    updateScriptName();
                    loadCues();
                } else if (data.type === 'camera_updated' || data.type === 'cue_updated' || data.type === 'cue_created' || data.type === 'cue_deleted') {
                    // Reload cues when camera assignments or cues are updated
                    loadCues();
                } else if (data.type === 'setting_updated' && data.key === 'script_name') {
                    document.getElementById('serviceName').textContent = data.value;
                }
            };
        }

        async function loadSettings() {
            try {
                const response = await fetch('/api/settings/script_name');
                const data = await response.json();
                if (data.value) {
                    document.getElementById('serviceName').textContent = data.value;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }
        
        function updateScriptName() {
            if (currentState) {
                document.getElementById('scriptName').textContent = currentState.script_name;
            }
        }
        
        async function loadCues() {
            try {
                const response = await fetch('/api/cues/all');
                const cues = await response.json();
                renderCues(cues);
            } catch (error) {
                console.error('Error loading cues:', error);
            }
        }
        
        function renderCues(cues) {
            const currentCue = cues.find(c => c.is_current);
            const upcomingCues = cues.filter(c => !c.is_current && c.sequence_number > (currentCue?.sequence_number || 0)).slice(0, 5);
            
            // Render Current Cue
            if (currentCue) {
                const activeCameras = (currentCue.cameras || []).filter(cam => cam.subject && cam.subject.trim());
                const hasActiveCameras = activeCameras.length > 0;
                
                document.getElementById('currentCue').innerHTML = `
                    <!-- Current Cue Header -->
                    <div class="bg-gradient-to-r from-blue-900/30 to-blue-800/20 border-l-4 border-blue-500 rounded-lg p-6 mb-6">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm">CURRENT</div>
                            <div class="text-3xl font-bold text-blue-300">Cue ${currentCue.sequence_number}</div>
                        </div>
                        <div class="text-2xl font-semibold text-white mb-2">${currentCue.line_text || 'Untitled Cue'}</div>
                        ${currentCue.notes ? `<div class="text-gray-300 text-base italic">${currentCue.notes}</div>` : ''}
                    </div>
                    
                    <!-- Camera Grid -->
                    ${hasActiveCameras ? `
                        <div class="camera-grid">
                            ${activeCameras.map(cam => renderCameraCard(cam, true)).join('')}
                        </div>
                    ` : `
                        <div class="text-center py-8 text-gray-500 bg-gray-800/50 rounded-lg border border-gray-700">
                            <div class="text-4xl mb-2 opacity-50">üìπ</div>
                            <div>No camera assignments for this cue</div>
                        </div>
                    `}
                `;
            } else {
                document.getElementById('currentCue').innerHTML = `
                    <div class="text-center py-16 text-gray-500">
                        <div class="text-5xl mb-4 opacity-50">üé¨</div>
                        <div class="text-xl">No current cue</div>
                    </div>
                `;
            }
            
            // Render Upcoming Cues
            if (upcomingCues.length > 0) {
                document.getElementById('upcomingSection').innerHTML = `
                    <div class="border-t-2 border-gray-800 pt-8">
                        <h2 class="text-xl font-bold text-gray-400 uppercase tracking-wide mb-6 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                            </svg>
                            Upcoming Cues
                        </h2>
                        <div class="space-y-4">
                            ${upcomingCues.map(cue => renderUpcomingCue(cue)).join('')}
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('upcomingSection').innerHTML = `
                    <div class="border-t-2 border-gray-800 pt-8">
                        <h2 class="text-xl font-bold text-gray-400 uppercase tracking-wide mb-6">Upcoming Cues</h2>
                        <div class="text-center py-8 text-gray-500">No more cues</div>
                    </div>
                `;
            }
        }
        
        function renderCameraCard(cam, isCurrent) {
            const isActive = cam.expected_take;
            const bgColor = isActive ? 'bg-gradient-to-br from-red-900 to-orange-900 border-2 border-red-500' : 'bg-gray-800 border-2 border-gray-700';
            const badgeColor = isActive ? 'bg-red-600 text-white animate-pulse' : 'bg-gray-700 text-gray-300';
            
            return `
                <div class="${bgColor} rounded-lg p-4 transition-all hover:scale-105">
                    <div class="flex items-center justify-between mb-3">
                        <div class="${badgeColor} px-3 py-1 rounded-lg text-sm font-bold">CAM ${cam.camera_number}</div>
                        ${isActive ? '<div class="text-red-400 text-sm font-bold">‚≠ê TAKE</div>' : ''}
                    </div>
                    <div class="${isActive ? 'text-white' : 'text-gray-200'} text-lg font-bold mb-2 leading-tight">${cam.subject}</div>
                    ${cam.shot_type ? `<div class="bg-black/30 text-gray-300 text-base px-2 py-1 rounded inline-block">${cam.shot_type}</div>` : ''}
                    ${cam.camera_notes ? `<div class="mt-2 text-amber-300 text-sm bg-amber-900/30 px-2 py-1 rounded">${cam.camera_notes}</div>` : ''}
                </div>
            `;
        }
        
        function renderUpcomingCue(cue) {
            const activeCameras = (cue.cameras || []).filter(cam => cam.subject && cam.subject.trim());
            const hasCameras = activeCameras.length > 0;
            
            return `
                <div class="bg-gray-800/50 border-l-4 border-orange-500 rounded-lg p-5 hover:bg-gray-800 transition-colors">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="bg-orange-600/80 text-white px-3 py-1 rounded text-sm font-bold">CUE ${cue.sequence_number}</div>
                        <div class="text-xl font-semibold text-orange-300">${cue.line_text || 'Untitled'}</div>
                    </div>
                    
                    ${hasCameras ? `
                        <div class="flex gap-2 flex-wrap">
                            ${activeCameras.map(cam => `
                                <div class="bg-gray-900 border border-gray-700 px-3 py-2 rounded-lg text-base flex items-center gap-2">
                                    <span class="text-orange-400 font-bold">Cam ${cam.camera_number}:</span>
                                    <span class="text-gray-200">${cam.subject}</span>
                                    ${cam.expected_take ? '<span class="text-red-400 text-sm">‚≠ê</span>' : ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : '<div class="text-gray-500 text-base">No camera assignments</div>'}
                </div>
            `;
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            connect();
            
            // Poll for updates every 2 seconds to catch manual camera edits
            setInterval(() => {
                loadCues();
            }, 2000);
        });

        // Start loading data immediately
        loadCues();
        loadSettings();
        connect();
    </script>
</body>
</html>