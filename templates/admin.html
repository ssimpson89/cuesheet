<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - CueSheet System</title>
    <script src="/static/vendor/tailwindcss.js"></script>
    <script src="/static/vendor/lucide.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-900 to-blue-700 min-h-screen p-5">
    <!-- Header with Aladdin Jr title and home button -->
    <header class="max-w-2xl mx-auto mb-5 flex items-center justify-between">
        <a href="/" class="text-2xl font-bold text-white hover:text-blue-200 transition-colors flex items-center gap-2">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
            </svg>
            <span id="displayServiceName">Aladdin Jr</span>
        </a>
        <span class="text-white/80">Admin Panel</span>
    </header>
    
    <div class="max-w-2xl mx-auto">
        <h1 class="text-2xl font-semibold text-white mb-2.5 flex items-center gap-2"><i data-lucide="settings" class="w-5 h-5"></i> Admin Panel</h1>
        <p class="text-white/80 mb-5">Manage system settings and data</p>

        <!-- Settings Section -->
        <div class="bg-white rounded-lg p-6 shadow-lg mb-5">
            <h2 class="text-xl font-semibold text-blue-900 mb-4 flex items-center gap-2"><i data-lucide="theater" class="w-5 h-5"></i> Service Settings</h2>
            <div class="mb-4">
                <label for="serviceNameInput" class="block text-gray-700 font-medium mb-2">Service/Show Name</label>
                <input 
                    type="text" 
                    id="serviceNameInput" 
                    placeholder="e.g., Aladdin Jr, Spring Concert, etc." 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    onkeydown="if(event.key==='Enter') updateServiceName()"
                />
                <p class="text-sm text-gray-500 mt-1">This name appears on all views</p>
            </div>
            <button class="px-6 py-3 bg-blue-600 text-white border-none rounded-lg text-base font-medium cursor-pointer transition-all hover:bg-blue-700" onclick="updateServiceName()">Update Service Name</button>
            <div id="settingsStatus" class="mt-4 p-4 rounded-lg hidden"></div>
        </div>

        <div class="bg-yellow-100 border-2 border-yellow-400 p-4 rounded-lg mb-5 text-yellow-800">
            <strong class="flex items-center gap-2 mb-1"><i data-lucide="alert-triangle" class="w-5 h-5"></i> Warning:</strong> The sections below contain destructive actions that cannot be undone. Make sure you have a backup before proceeding.
        </div>

        <div class="bg-white rounded-lg p-6 shadow-lg mb-5">
            <h2 class="text-xl font-semibold text-blue-900 mb-4 flex items-center gap-2"><i data-lucide="trash-2" class="w-5 h-5"></i> Clear All Data</h2>
            <p class="text-gray-600 mb-4 leading-relaxed">
                This will permanently delete ALL cues and camera assignments from the database. This action cannot be undone.
            </p>
            <p class="text-red-600 font-medium mb-4 flex items-center gap-2">
                <i data-lucide="alert-triangle" class="w-5 h-5"></i> This will delete everything - use only when starting a completely new production.
            </p>
            <button class="px-6 py-3 bg-red-600 text-white border-none rounded-lg text-base font-medium cursor-pointer transition-all hover:bg-red-700 hover:-translate-y-0.5" onclick="showClearModal()">Clear All Data</button>
            <div id="clearStatus" class="mt-4 p-4 rounded-lg hidden"></div>
        </div>

        <div class="bg-white rounded-lg p-6 shadow-lg mb-5">
            <h2 class="text-xl font-semibold text-blue-900 mb-4 flex items-center gap-2"><i data-lucide="upload" class="w-5 h-5"></i> Export Data</h2>
            <p class="text-gray-600 mb-4 leading-relaxed">
                Download all cues and camera assignments as a CSV file. This is useful for backups or editing in spreadsheet software.
            </p>
            <button class="px-6 py-3 bg-gray-600 text-white border-none rounded-lg text-base font-medium cursor-pointer transition-all hover:bg-gray-700" onclick="exportCSV()">Export to CSV</button>
        </div>

        <div class="bg-white rounded-lg p-6 shadow-lg mb-5">
            <h2 class="text-xl font-semibold text-blue-900 mb-4 flex items-center gap-2"><i data-lucide="download" class="w-5 h-5"></i> Import Data</h2>
            <p class="text-gray-600 mb-4 leading-relaxed">
                Import cues and camera assignments from a CSV file. This will replace all current data.
            </p>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all" 
                 onclick="document.getElementById('csvFile').click()"
                 ondragover="event.preventDefault(); this.classList.add('border-blue-500', 'bg-blue-50');"
                 ondragleave="this.classList.remove('border-blue-500', 'bg-blue-50');"
                 ondrop="event.preventDefault(); this.classList.remove('border-blue-500', 'bg-blue-50'); handleFileDrop(event);">
                <p class="text-4xl mb-3"><i data-lucide="file-spreadsheet" class="w-8 h-8 mb-2 text-blue-500"></i></p>
                <p class="text-gray-700 font-medium">Drag & drop your CSV file here</p>
                <p class="text-gray-500 text-sm mt-1">or click to browse</p>
            </div>
            <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
            <div id="importStatus" class="mt-4 p-4 rounded-lg hidden"></div>
        </div>

        <div class="bg-white rounded-lg p-6 shadow-lg mb-5">
            <h2 class="text-xl font-semibold text-blue-900 mb-4 flex items-center gap-2"><i data-lucide="database" class="w-5 h-5"></i> Database Backup</h2>
            <p class="text-gray-600 mb-4 leading-relaxed">
                Create a backup of the current database. Backups are stored locally and the last <span id="backupCountDisplay">10</span> are kept.
            </p>
            <button class="px-6 py-3 bg-blue-600 text-white border-none rounded-lg text-base font-medium cursor-pointer transition-all hover:bg-blue-700" onclick="createBackup()">Make Backup</button>
            <div id="backupStatus" class="mt-4 p-4 rounded-lg hidden"></div>

            <div class="mt-6">
                <h3 class="text-lg font-medium text-blue-900 mb-3 flex items-center gap-2"><i data-lucide="history" class="w-5 h-5"></i> Available Backups</h3>
                <div id="backupsList" class="space-y-2 max-h-64 overflow-y-auto">
                    <p class="text-gray-500 italic">Loading backups...</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg p-6 shadow-lg mb-5">
            <h2 class="text-xl font-semibold text-blue-900 mb-4 flex items-center gap-2"><i data-lucide="upload" class="w-5 h-5"></i> Upload Backup</h2>
            <p class="text-gray-600 mb-4 leading-relaxed">
                Upload a .db backup file to restore or add to your backup list.
            </p>
            <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all"
                 onclick="document.getElementById('backupFile').click()">
                <p class="text-4xl mb-2"><i data-lucide="file-up" class="w-8 h-8 text-blue-500"></i></p>
                <p class="text-gray-700 font-medium">Click or drag & drop a .db backup file</p>
            </div>
            <input type="file" id="backupFile" accept=".db" style="display: none;" onchange="handleBackupFileSelect(event)">
            <div id="uploadStatus" class="mt-4 p-4 rounded-lg hidden"></div>
        </div>

        </div>

        <div class="text-center text-white/60 text-sm mt-6">
            Version: <span id="appVersion">...</span>
        </div>
    </div>

    <!-- Import Data Modal -->
    <div id="importModal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-8 max-w-md w-[90%] shadow-2xl">
            <h3 class="text-2xl font-semibold text-red-600 mb-4 flex items-center gap-2"><i data-lucide="alert-triangle" class="w-5 h-5"></i> Replace All Data?</h3>
            <p class="text-gray-700 mb-5 leading-relaxed">
                This will <span class="text-red-600 font-medium">permanently replace</span> ALL existing cues and camera assignments with the data from the CSV file.
            </p>
            <p class="text-red-600 font-semibold mb-6">
                Current data will be lost forever!
            </p>
            <div class="flex gap-3 justify-end">
                <button class="px-5 py-2.5 rounded-lg font-medium transition-colors bg-gray-600 text-white hover:bg-gray-700" onclick="closeImportModal()">Cancel</button>
                <button class="px-5 py-2.5 rounded-lg font-medium transition-colors bg-blue-600 text-white hover:bg-blue-700" onclick="confirmImport()">Yes, Replace All Data</button>
            </div>
        </div>
    </div>

    <!-- Clear All Data Modal -->
    <div id="clearModal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-8 max-w-md w-[90%] shadow-2xl">
            <h3 class="text-2xl font-semibold text-red-600 mb-4 flex items-center gap-2"><i data-lucide="alert-triangle" class="w-5 h-5"></i> Clear All Data</h3>
            <p class="text-gray-700 mb-5 leading-relaxed">
                Are you absolutely sure you want to delete ALL cues and camera assignments? This action is permanent and cannot be undone.
            </p>
            <p class="text-red-600 font-semibold mb-6">
                All data will be lost forever!
            </p>
            <div class="flex gap-3 justify-end">
                <button class="px-5 py-2.5 rounded-lg font-medium transition-colors bg-gray-600 text-white hover:bg-gray-700" onclick="closeClearModal()">Cancel</button>
                <button class="px-5 py-2.5 rounded-lg font-medium transition-colors bg-red-600 text-white hover:bg-red-700" onclick="confirmClear()">Yes, Delete Everything</button>
            </div>
        </div>
    </div>

    <!-- Restore Backup Modal -->
    <div id="restoreModal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-8 max-w-md w-[90%] shadow-2xl">
            <h3 class="text-2xl font-semibold text-red-600 mb-4 flex items-center gap-2"><i data-lucide="alert-triangle" class="w-5 h-5"></i> Restore Backup?</h3>
            <p class="text-gray-700 mb-5 leading-relaxed">
                This will <span class="text-red-600 font-medium">completely replace</span> the current database with the selected backup.
            </p>
            <p class="text-red-600 font-semibold mb-6">
                All current data will be lost!
            </p>
            <p class="text-gray-600 text-sm mb-4">
                A safety backup of your current database will be created before restoring.
            </p>
            <div class="flex gap-3 justify-end">
                <button class="px-5 py-2.5 rounded-lg font-medium transition-colors bg-gray-600 text-white hover:bg-gray-700" onclick="closeRestoreModal()">Cancel</button>
                <button class="px-5 py-2.5 rounded-lg font-medium transition-colors bg-red-600 text-white hover:bg-red-700" id="confirmRestoreBtn">Yes, Restore Backup</button>
            </div>
        </div>
    </div>

    <!-- Delete Backup Modal -->
    <div id="deleteBackupModal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-8 max-w-md w-[90%] shadow-2xl">
            <h3 class="text-2xl font-semibold text-red-600 mb-4 flex items-center gap-2"><i data-lucide="trash-2" class="w-5 h-5"></i> Delete Backup?</h3>
            <p class="text-gray-700 mb-5 leading-relaxed">
                Are you sure you want to delete this backup?
            </p>
            <p class="text-gray-600 text-sm mb-4" id="deleteBackupFilename"></p>
            <p class="text-red-600 font-semibold mb-6">
                This cannot be undone!
            </p>
            <div class="flex gap-3 justify-end">
                <button class="px-5 py-2.5 rounded-lg font-medium transition-colors bg-gray-600 text-white hover:bg-gray-700" onclick="closeDeleteBackupModal()">Cancel</button>
                <button class="px-5 py-2.5 rounded-lg font-medium transition-colors bg-red-600 text-white hover:bg-red-700" id="confirmDeleteBackupBtn">Yes, Delete Backup</button>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-8 max-w-md w-[90%] shadow-2xl">
            <h3 class="text-2xl font-semibold text-red-600 mb-4 flex items-center gap-2"><i data-lucide="alert-circle" class="w-5 h-5"></i> Error</h3>
            <p class="text-gray-700 mb-5 leading-relaxed" id="errorModalMessage"></p>
            <div class="flex gap-3 justify-end">
                <button class="px-5 py-2.5 rounded-lg font-medium transition-colors bg-blue-600 text-white hover:bg-blue-700" onclick="closeErrorModal()">OK</button>
            </div>
        </div>
    </div>

    <script>
        // Load current settings on page load
        let selectedFile = null;

        async function loadSettings() {
            try {
                const response = await fetch('/api/settings/script_name');
                const data = await response.json();
                if (data.value) {
                    document.getElementById('serviceNameInput').value = data.value;
                    document.getElementById('displayServiceName').textContent = data.value;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
            
            try {
                const versionResponse = await fetch('/api/version');
                const versionData = await versionResponse.json();
                document.getElementById('appVersion').textContent = versionData.version;
            } catch (error) {
                console.error('Error loading version:', error);
                document.getElementById('appVersion').textContent = 'unknown';
            }
        }

        // Update service name
        async function updateServiceName() {
            const serviceName = document.getElementById('serviceNameInput').value.trim();
            
            if (!serviceName) {
                showErrorModal('Please enter a service name');
                return;
            }

            const statusEl = document.getElementById('settingsStatus');
            statusEl.textContent = 'Updating service name...';
            statusEl.className = 'mt-4 p-4 rounded-lg block';
            statusEl.classList.remove('bg-green-100', 'text-green-800', 'border', 'border-green-300', 'bg-red-100', 'text-red-800', 'border-red-300');

            try {
                const response = await fetch('/api/settings/script_name', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `value=${encodeURIComponent(serviceName)}`
                });
                const result = await response.json();

                if (result.success) {
                    statusEl.textContent = '✓ Service name updated successfully. All views will show the new name.';
                    statusEl.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-300');
                    
                    // Update header
                    document.getElementById('displayServiceName').textContent = serviceName;
                } else {
                    statusEl.textContent = `✗ Failed to update: ${result.message || 'Unknown error'}`;
                    statusEl.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-300');
                }
            } catch (error) {
                console.error('Error updating service name:', error);
                statusEl.textContent = '✗ Failed to update service name. Please try again.';
                statusEl.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-300');
            }
        }

        function showClearModal() {
            document.getElementById('clearModal').classList.remove('hidden');
            document.getElementById('clearModal').classList.add('flex');
        }

        function closeClearModal() {
            document.getElementById('clearModal').classList.add('hidden');
            document.getElementById('clearModal').classList.remove('flex');
        }

        // Load settings when page loads
        document.addEventListener('DOMContentLoaded', loadSettings);

        async function confirmClear() {
            closeClearModal();
            
            const statusEl = document.getElementById('clearStatus');
            statusEl.textContent = 'Clearing all data...';
            statusEl.className = 'mt-4 p-4 rounded-lg block';
            statusEl.classList.remove('bg-green-100', 'text-green-800', 'border', 'border-green-300', 'bg-red-100', 'text-red-800', 'border-red-300');
            
            try {
                const response = await fetch('/api/start-over', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    statusEl.textContent = '✓ All data has been cleared successfully. The database is now empty.';
                    statusEl.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-300');
                } else {
                    statusEl.textContent = `✗ Failed to clear data: ${result.message}`;
                    statusEl.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-300');
                }
            } catch (error) {
                console.error('Error clearing data:', error);
                statusEl.textContent = '✗ Failed to clear data. Please try again.';
                statusEl.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-300');
            }
        }

        function showImportModal() {
            document.getElementById('importModal').classList.remove('hidden');
            document.getElementById('importModal').classList.add('flex');
        }
        
        function handleFileSelect(event) {
            selectedFile = event.target.files[0];
            if (selectedFile) {
                showImportModal();
            }
        }
        
        function handleFileDrop(event) {
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                selectedFile = files[0];
                showImportModal();
            }
        }
        
        function closeImportModal() {
            document.getElementById('importModal').classList.add('hidden');
            document.getElementById('importModal').classList.remove('flex');
            document.getElementById('csvFile').value = '';
            selectedFile = null;
        }
        
        async function confirmImport() {
            if (!selectedFile) {
                showErrorModal('Please select a CSV file first');
                closeImportModal();
                return;
            }

            const fileToImport = selectedFile;
            closeImportModal();
            await importCSV(fileToImport);
        }
        
        function exportCSV() {
            window.location.href = '/api/export/csv';
        }

        async function importCSV(file) {
            const statusEl = document.getElementById('importStatus');
            statusEl.textContent = 'Importing data...';
            statusEl.className = 'mt-4 p-4 rounded-lg block';
            statusEl.classList.remove('bg-green-100', 'text-green-800', 'border', 'border-green-300', 'bg-red-100', 'text-red-800', 'border-red-300');

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/import/csv', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.success) {
                    statusEl.innerHTML = `
                        <div class="font-bold mb-1">✓ Import successful</div>
                        <div class="text-sm opacity-90">Imported ${result.cues_imported} cues and ${result.assignments_imported} camera assignments.</div>
                    `;
                    statusEl.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-300');
                    document.getElementById('csvFile').value = '';
                } else {
                    let errorHtml = `<div class="font-bold mb-2">✗ Import failed: ${result.message}</div>`;
                    if (result.errors && result.errors.length > 0) {
                        errorHtml += `<ul class="text-sm list-disc list-inside space-y-1 mt-2 max-h-48 overflow-y-auto bg-red-50 p-2 rounded border border-red-200">`;
                        result.errors.forEach(err => {
                            errorHtml += `<li>${err}</li>`;
                        });
                        errorHtml += `</ul>`;
                        errorHtml += `<div class="text-xs mt-2 italic">Please fix these issues in your CSV and try again. No data was changed.</div>`;
                    }
                    statusEl.innerHTML = errorHtml;
                    statusEl.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-300');
                }
            } catch (error) {
                console.error('Error importing:', error);
                statusEl.textContent = '✗ Failed to import data. Please check the CSV format.';
                statusEl.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-300');
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeClearModal();
                closeImportModal();
            } else if (e.key === 'Enter') {
                if (!document.getElementById('clearModal').classList.contains('hidden')) {
                    confirmClear();
                } else if (!document.getElementById('importModal').classList.contains('hidden')) {
                    confirmImport();
                }
            }
        });

        document.getElementById('clearModal').addEventListener('click', (e) => {
            if (e.target.id === 'clearModal') {
                closeClearModal();
            }
        });

        let selectedBackupToRestore = null;

        function showRestoreModal(filename) {
            if (!filename) {
                console.error('No filename provided to showRestoreModal');
                return;
            }
            selectedBackupToRestore = filename;
            document.getElementById('restoreModal').classList.remove('hidden');
            document.getElementById('restoreModal').classList.add('flex');
        }

        function closeRestoreModal() {
            document.getElementById('restoreModal').classList.add('hidden');
            document.getElementById('restoreModal').classList.remove('flex');
            selectedBackupToRestore = null;
        }

        async function confirmRestore() {
            if (!selectedBackupToRestore) {
                console.error('No backup selected for restore');
                return;
            }

            const filenameToRestore = selectedBackupToRestore;
            
            closeRestoreModal();

            const statusEl = document.getElementById('backupStatus');
            statusEl.textContent = 'Restoring backup...';
            statusEl.className = 'mt-4 p-4 rounded-lg block bg-blue-100 text-blue-800 border border-blue-300';

            try {
                const encodedFilename = encodeURIComponent(filenameToRestore);
                const response = await fetch(`/api/backup/restore/${encodedFilename}`, { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    statusEl.innerHTML = `✓ ${result.message}`;
                    statusEl.className = 'mt-4 p-4 rounded-lg block bg-green-100 text-green-800 border border-green-300';
                } else {
                    statusEl.textContent = `✗ Failed to restore: ${result.message}`;
                    statusEl.className = 'mt-4 p-4 rounded-lg block bg-red-100 text-red-800 border border-red-300';
                }
            } catch (error) {
                console.error('Error restoring backup:', error);
                statusEl.textContent = '✗ Failed to restore backup. Please try again.';
                statusEl.className = 'mt-4 p-4 rounded-lg block bg-red-100 text-red-800 border border-red-300';
            }
        }

        document.getElementById('restoreModal').addEventListener('click', (e) => {
            if (e.target.id === 'restoreModal') {
                closeRestoreModal();
            }
        });

        document.getElementById('confirmRestoreBtn').addEventListener('click', confirmRestore);

        document.getElementById('deleteBackupModal').addEventListener('click', (e) => {
            if (e.target.id === 'deleteBackupModal') {
                closeDeleteBackupModal();
            }
        });

        document.getElementById('confirmDeleteBackupBtn').addEventListener('click', confirmDeleteBackup);

        document.getElementById('errorModal').addEventListener('click', (e) => {
            if (e.target.id === 'errorModal') {
                closeErrorModal();
            }
        });

        let selectedBackupFile = null;

        function handleBackupFileSelect(event) {
            selectedBackupFile = event.target.files[0];
            if (selectedBackupFile) {
                uploadBackup(selectedBackupFile);
            }
        }

        async function uploadBackup(file) {
            const statusEl = document.getElementById('uploadStatus');
            statusEl.textContent = 'Uploading backup...';
            statusEl.className = 'mt-4 p-4 rounded-lg block bg-blue-100 text-blue-800 border border-blue-300';

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/backup/upload', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.success) {
                    statusEl.innerHTML = `✓ Backup uploaded successfully: ${result.filename}`;
                    statusEl.className = 'mt-4 p-4 rounded-lg block bg-green-100 text-green-800 border border-green-300';
                    loadBackups();
                } else {
                    statusEl.textContent = `✗ Failed to upload: ${result.message}`;
                    statusEl.className = 'mt-4 p-4 rounded-lg block bg-red-100 text-red-800 border border-red-300';
                }
            } catch (error) {
                console.error('Error uploading backup:', error);
                statusEl.textContent = '✗ Failed to upload backup. Please try again.';
                statusEl.className = 'mt-4 p-4 rounded-lg block bg-red-100 text-red-800 border border-red-300';
            }

            document.getElementById('backupFile').value = '';
        }

        // Drag and drop handlers
        const dropZone = document.getElementById('dropZone');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('border-blue-500', 'bg-blue-50');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.name.endsWith('.db')) {
                    uploadBackup(file);
                } else {
                    const statusEl = document.getElementById('uploadStatus');
                    statusEl.textContent = '✗ Please upload a .db file';
                    statusEl.className = 'mt-4 p-4 rounded-lg block bg-red-100 text-red-800 border border-red-300';
                }
            }
        });

        // Initialize Lucide icons
        lucide.createIcons();

        async function loadBackups() {
            const listEl = document.getElementById('backupsList');
            try {
                const response = await fetch('/api/backups');
                const data = await response.json();

                // Update backup count display
                if (data.backup_count) {
                    document.getElementById('backupCountDisplay').textContent = data.backup_count;
                }

                if (data.success && data.backups.length > 0) {
                    listEl.innerHTML = data.backups.map(backup => `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div>
                                <div class="font-medium text-gray-800">${backup.filename}</div>
                                <div class="text-sm text-gray-500">
                                    ${new Date(backup.created_at).toLocaleString()} · ${(backup.size / 1024).toFixed(1)} KB
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button class="px-3 py-1.5 bg-green-600 text-white text-sm rounded hover:bg-green-700 transition-colors restore-btn"
                                        data-filename="${backup.filename}">
                                    Restore
                                </button>
                                <a href="/api/backups/${encodeURIComponent(backup.filename)}" download
                                   class="px-3 py-1.5 bg-gray-600 text-white text-sm rounded hover:bg-gray-700 transition-colors">
                                    Download
                                </a>
                                <button class="px-3 py-1.5 bg-red-600 text-white text-sm rounded hover:bg-red-700 transition-colors delete-btn"
                                        data-filename="${backup.filename}">
                                    Delete
                                </button>
                            </div>
                        </div>
                    `).join('');
                    document.querySelectorAll('.restore-btn').forEach(btn => {
                        btn.addEventListener('click', () => showRestoreModal(btn.dataset.filename));
                    });
                    document.querySelectorAll('.delete-btn').forEach(btn => {
                        btn.addEventListener('click', () => deleteBackup(btn.dataset.filename));
                    });
                } else {
                    listEl.innerHTML = '<p class="text-gray-500 italic">No backups available</p>';
                }
            } catch (error) {
                console.error('Error loading backups:', error);
                listEl.innerHTML = '<p class="text-gray-500 italic">Failed to load backups</p>';
            }
        }

        async function createBackup() {
            const statusEl = document.getElementById('backupStatus');
            statusEl.textContent = 'Creating backup...';
            statusEl.className = 'mt-4 p-4 rounded-lg block bg-blue-100 text-blue-800 border border-blue-300';

            try {
                const response = await fetch('/api/backup', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    statusEl.innerHTML = `✓ Backup created successfully: ${result.filename}`;
                    statusEl.className = 'mt-4 p-4 rounded-lg block bg-green-100 text-green-800 border border-green-300';
                    loadBackups();
                } else {
                    statusEl.textContent = `✗ Failed to create backup: ${result.message}`;
                    statusEl.className = 'mt-4 p-4 rounded-lg block bg-red-100 text-red-800 border border-red-300';
                }
            } catch (error) {
                console.error('Error creating backup:', error);
                statusEl.textContent = '✗ Failed to create backup. Please try again.';
                statusEl.className = 'mt-4 p-4 rounded-lg block bg-red-100 text-red-800 border border-red-300';
            }
        }

        let selectedBackupToDelete = null;

        function showDeleteBackupModal(filename) {
            selectedBackupToDelete = filename;
            document.getElementById('deleteBackupFilename').textContent = filename;
            document.getElementById('deleteBackupModal').classList.remove('hidden');
            document.getElementById('deleteBackupModal').classList.add('flex');
        }

        function closeDeleteBackupModal() {
            document.getElementById('deleteBackupModal').classList.add('hidden');
            document.getElementById('deleteBackupModal').classList.remove('flex');
            selectedBackupToDelete = null;
        }

        async function confirmDeleteBackup() {
            if (!selectedBackupToDelete) return;

            const filename = selectedBackupToDelete;
            closeDeleteBackupModal();

            try {
                const response = await fetch(`/api/backups/${encodeURIComponent(filename)}`, { method: 'DELETE' });
                const result = await response.json();

                if (result.success) {
                    loadBackups();
                } else {
                    showErrorModal('Failed to delete backup: ' + result.message);
                }
            } catch (error) {
                console.error('Error deleting backup:', error);
                showErrorModal('Failed to delete backup. Please try again.');
            }
        }

        function showErrorModal(message) {
            document.getElementById('errorModalMessage').textContent = message;
            document.getElementById('errorModal').classList.remove('hidden');
            document.getElementById('errorModal').classList.add('flex');
        }

        function closeErrorModal() {
            document.getElementById('errorModal').classList.add('hidden');
            document.getElementById('errorModal').classList.remove('flex');
        }

        async function deleteBackup(filename) {
            showDeleteBackupModal(filename);
        }

document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            loadBackups();
        });
    </script>
</body>
</html>